<!doctype html public "-//w3c//dtd html 4.0 transitional//en">
<html>
<head>
   <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
   <meta name="GENERATOR" content="Mozilla/4.51 [en] (WinNT; U) [Netscape]">
   <title>Reducing Code Size on ARM/Thumb processors</title>
</head>
<body bgcolor="#FFFFFF">

<h1 CLASS="AppendixTitle">
<a NAME="pgfId-485115"></a>Reducing Code Size on ARM/Thumb processors
<hr WIDTH="100%"></h1>
&nbsp;
<p>&nbsp;

<p CLASS="BodyAfterHead"><a NAME="pgfId-485130"></a>Some ARM processor
cores support two different instruction sets. They can run the standard
ARM instruction set, where each instruction occupies 32 bits, and also
the reduced size Thumb instruction set, where each instruction occupies
16 bits. Thumb instructions are more limited in what they can do compared
to ARM instructions, but they can represent a considerable saving in the
amount of space occupied by the instructions. It is possible to dynamically
switch between the two instruction-sets, thus gaining the advantages of
both.

<p CLASS="Body"><a NAME="pgfId-482542"></a>The GNUPro compilers are able
to produce code for both the ARM and Thumb instruction sets, but only at
a file level of granularity. Thus the programmer can choose whether individual
functions should be encoded as either ARM or Thumb instructions, but they
cannot specify that specific parts of a function should be ARM or Thumb.
The other parts of the GNUPro tools (the assembler and linker and so on),
all support mixing ARM and Thumb code at any level.

<p CLASS="Body"><a NAME="pgfId-482543"></a>The GNUPro toolkit has two compilers,
one of which produces ARM assembler, and the other produces Thumb assembler.
If the programmer wants to use just one instruction set to compile their
program then no special procedures need to be followed, other than selecting
the correct compiler. If the programmer wants to use both instruction sets
in their program, then they must separate the ARM and Thumb parts of their
program into separate files and compile each individually, while also specifiying
the '<tt>-mthumb-interwork</tt>' command line flag. When the assembled
object files are linked together the linker will generate special code
to switch between the two instruction sets whenever a call is made from
an ARM function to a Thumb function or vice versa.
<h2 CLASS="Heading2">
<a NAME="pgfId-482544"></a>1. Create source code
<hr WIDTH="100%"></h2>

<p CLASS="Body"><a NAME="pgfId-482545"></a>Create the following sample
source code and save it as '<tt>arm_stuff.c</tt>'.</p>

<blockquote><font face="Courier New,Courier"><font size=-1>extern int thumb_func
(int);</font></font>
<br><font face="Courier New,Courier"><font size=-1>int main (void) { return
7 + thumb_func (7); }</font></font></blockquote>

<p CLASS="Body"><a NAME="pgfId-482548"></a>Create the following sample
source code and save it as '<tt>thumb_stuff.c</tt>'.</p>

<blockquote>
<p CLASS="CodeExample"><a NAME="pgfId-482549"></a><font face="Courier New,Courier"><font size=-1>int
thumb_func (int arg) { return arg + 7; }</font></font></p>
</blockquote>

<h2 CLASS="Heading2">
<a NAME="pgfId-482550"></a>2. Compile and link from source code
<hr WIDTH="100%"></h2>

<p CLASS="Body"><a NAME="pgfId-482551"></a>First compile the ARM sample
code:</p>

<br>&nbsp;
<table WIDTH="600" >
<tr>
<td>
<p CLASS="CodeScreen"><a NAME="pgfId-482666"></a><font face="Courier New,Courier"><font size=-1><b>%</b>
arm-elf-gcc -g -c -O2 -mthumb-interwork arm_stuff.c</font></font></p>
</td>
</tr>

<tr>
<td>
<p CLASS="CodeScreen"><a NAME="pgfId-482668"></a><b><font face="Courier New,Courier"><font size=-1>%</font></font></b></p>
</td>
</tr>
</table>


<p CLASS="Body"><a NAME="pgfId-482554"></a>Then compile the Thumb sample
code:
<br>&nbsp;
<table WIDTH="600" >
<tr>
<td>
<p CLASS="CodeScreen"><a NAME="pgfId-482660"></a><font face="Courier New,Courier"><font size=-1><b>%</b>
thumb-elf-gcc -g -c -O2 -mthumb-interwork thumb_stuff.c</font></font></p>
</td>
</tr>

<tr>
<td>
<p CLASS="CodeScreen"><a NAME="pgfId-482662"></a><b><font face="Courier New,Courier"><font size=-1>%</font></font></b></p>
</td>
</tr>
</table>


<p CLASS="Body"><a NAME="pgfId-482557"></a>Then link
<br>&nbsp;
<table WIDTH="600" >
<tr>
<td>
<p CLASS="CodeScreen"><a NAME="pgfId-482654"></a><font face="Courier New,Courier"><font size=-1><b>%</b>
arm-elf-gcc arm_stuff.o thumb_stuff.o -mthumb-interwork -o program</font></font></p>
</td>
</tr>

<tr>
<td>
<p CLASS="CodeScreen"><a NAME="pgfId-482656"></a><b><font face="Courier New,Courier"><font size=-1>%</font></font></b></p>
</td>
</tr>
</table>


<p CLASS="Body"><a NAME="pgfId-482560"></a>The '<tt>-g</tt>' and '<tt>-O2</tt>'
command-line options are optional. They are used here to make the output
of the debugger easier to understand.
<h2 CLASS="Heading2">
<a NAME="pgfId-482561"></a>3. Run on the GNUPro Simulator
<hr WIDTH="100%"></h2>

<p CLASS="Body"><a NAME="pgfId-485484"></a>The following sample debugging
session was run on the GNUPro ARM simulator. Although the GNUPro ARM simulator
is not a supported platform under eCos, the following sample GDB session
demonstrates the resulting code size reduction. The GDB release date, the
host configuration, and the '<tt>target</tt>' command will vary.</p>

<br>&nbsp;
<table>
<tr>
<td>
<p CLASS="CodeScreen"><a NAME="pgfId-485362"></a><tt>%</tt><font face="Courier New,Courier"><font size=-1>arm-elf-gdb
program</font></font></p>
</td>
</tr>

<tr>
<td>
<p CLASS="CodeScreen"><a NAME="pgfId-485364"></a><b><font face="Courier New,Courier"><font size=-1>GNU
gdb 4.18-ecos-99r1-991015</font></font></b></p>
</td>
</tr>

<tr>
<td>
<p CLASS="CodeScreen"><a NAME="pgfId-485366"></a><b><font face="Courier New,Courier"><font size=-1>Copyright
1998 Free Software Foundation, Inc. GDB is free software, covered by the
GNU General Public License, and you are welcome to change it and/or distribute
copies of it under certain conditions. Type "show copying" to see the conditions.
This version of GDB is supported for customers of Cygnus Solutions. Type
"show warranty" for details.&nbsp;</font></font></b></p>
</td>
</tr>

<tr>
<td>
<p CLASS="CodeScreen"><a NAME="pgfId-485368"></a><b><font face="Courier New,Courier"><font size=-1>This
GDB was configured as "--host=sparc-solaris-2.6 --target=arm-elf"...</font></font></b></p>
</td>
</tr>

<tr>
<td>
<p CLASS="CodeScreen"><a NAME="pgfId-485370"></a></p>
</td>
</tr>

<tr>
<td>
<p CLASS="CodeScreen"><a NAME="pgfId-485372"></a><font face="Courier New,Courier"><font size=-1><b>(gdb)
</b>target
sim</font></font></p>
</td>
</tr>

<tr>
<td>
<p CLASS="CodeScreen"><a NAME="pgfId-485374"></a><b><font face="Courier New,Courier"><font size=-1>Connected
to the simulator.</font></font></b></p>
</td>
</tr>

<tr>
<td>
<p CLASS="CodeScreen"><a NAME="pgfId-485376"></a></p>
</td>
</tr>

<tr>
<td>
<p CLASS="CodeScreen"><a NAME="pgfId-485378"></a><font face="Courier New,Courier"><font size=-1><b>(gdb)
</b>load</font></font></p>
</td>
</tr>

<tr>
<td>
<p CLASS="CodeScreen"><a NAME="pgfId-485380"></a><b><font face="Courier New,Courier"><font size=-1>Loading
section .text, size 0x1858 vma 0x8000</font></font></b></p>
</td>
</tr>

<tr>
<td>
<p CLASS="CodeScreen"><a NAME="pgfId-485382"></a><b><font face="Courier New,Courier"><font size=-1>Loading
section .rodata, size 0x2c vma 0x9858</font></font></b></p>
</td>
</tr>

<tr>
<td>
<p CLASS="CodeScreen"><a NAME="pgfId-485384"></a><b><font face="Courier New,Courier"><font size=-1>Loading
section .data, size 0x850 vma 0x9984</font></font></b></p>
</td>
</tr>

<tr>
<td>
<p CLASS="CodeScreen"><a NAME="pgfId-485386"></a><b><font face="Courier New,Courier"><font size=-1>Loading
section .ctors, size 0x8 vma 0xa1d4</font></font></b></p>
</td>
</tr>

<tr>
<td>
<p CLASS="CodeScreen"><a NAME="pgfId-485388"></a><b><font face="Courier New,Courier"><font size=-1>Loading
section .dtors, size 0x8 vma 0xa1dc</font></font></b></p>
</td>
</tr>

<tr>
<td>
<p CLASS="CodeScreen"><a NAME="pgfId-485390"></a><b><font face="Courier New,Courier"><font size=-1>Start
address 0x8000</font></font></b></p>
</td>
</tr>

<tr>
<td>
<p CLASS="CodeScreen"><a NAME="pgfId-485392"></a><b><font face="Courier New,Courier"><font size=-1>Transfer
rate: 67360 bits in &lt;1 sec.</font></font></b></p>
</td>
</tr>

<tr>
<td>
<p CLASS="CodeScreen"><a NAME="pgfId-485394"></a></p>
</td>
</tr>

<tr>
<td>
<p CLASS="CodeScreen"><a NAME="pgfId-485396"></a><font face="Courier New,Courier"><font size=-1><b>(gdb)
</b>break
main</font></font></p>
</td>
</tr>

<tr>
<td>
<p CLASS="CodeScreen"><a NAME="pgfId-485398"></a><b><font face="Courier New,Courier"><font size=-1>Breakpoint
1 at 0x80ec: file arm_stuff.c, line 2.</font></font></b></p>
</td>
</tr>

<tr>
<td>
<p CLASS="CodeScreen"><a NAME="pgfId-485400"></a></p>
</td>
</tr>

<tr>
<td>
<p CLASS="CodeScreen"><a NAME="pgfId-485402"></a><font face="Courier New,Courier"><font size=-1><b>(gdb)
</b>break
thumb_func</font></font></p>
</td>
</tr>

<tr>
<td>
<p CLASS="CodeScreen"><a NAME="pgfId-485404"></a><b><font face="Courier New,Courier"><font size=-1>Breakpoint
2 at 0x8104: file thumb_stuff.c, line 1.</font></font></b></p>
</td>
</tr>

<tr>
<td>
<p CLASS="CodeScreen"><a NAME="pgfId-485406"></a></p>
</td>
</tr>

<tr>
<td>
<p CLASS="CodeScreen"><a NAME="pgfId-485408"></a><font face="Courier New,Courier"><font size=-1><b>(gdb)
</b>run</font></font></p>
</td>
</tr>

<tr>
<td>
<p CLASS="CodeScreen"><a NAME="pgfId-485410"></a><b><font face="Courier New,Courier"><font size=-1>Starting
program: /tmp/program&nbsp;</font></font></b></p>
</td>
</tr>

<tr>
<td>
<p CLASS="CodeScreen"><a NAME="pgfId-485412"></a></p>
</td>
</tr>

<tr>
<td>
<p CLASS="CodeScreen"><a NAME="pgfId-485414"></a><b><font face="Courier New,Courier"><font size=-1>Breakpoint
1, 0x80ec in main () at arm_stuff.c:2</font></font></b></p>
</td>
</tr>

<tr>
<td>
<p CLASS="CodeScreen"><a NAME="pgfId-485416"></a><b><font face="Courier New,Courier"><font size=-1>2
int main (void) { return 7 + thumb_func(7) ; }</font></font></b></p>
</td>
</tr>

<tr>
<td>
<p CLASS="CodeScreen"><a NAME="pgfId-485418"></a></p>
</td>
</tr>

<tr>
<td>
<p CLASS="CodeScreen"><a NAME="pgfId-485420"></a><font face="Courier New,Courier"><font size=-1><b>(gdb)
</b>disassemble</font></font></p>
</td>
</tr>

<tr>
<td>
<p CLASS="CodeScreen"><a NAME="pgfId-485422"></a><b><font face="Courier New,Courier"><font size=-1>Dump
of assembler code for function main:</font></font></b></p>
</td>
</tr>

<tr>
<td>
<p CLASS="CodeScreen"><a NAME="pgfId-485424"></a><b><font face="Courier New,Courier"><font size=-1>0x80e0
&lt;main>: mov ip, sp</font></font></b></p>
</td>
</tr>

<tr>
<td>
<p CLASS="CodeScreen"><a NAME="pgfId-485426"></a><b><font face="Courier New,Courier"><font size=-1>0x80e4
&lt;main+4>: stmdb sp!, {fp, ip, lr, pc}</font></font></b></p>
</td>
</tr>

<tr>
<td>
<p CLASS="CodeScreen"><a NAME="pgfId-485428"></a><b><font face="Courier New,Courier"><font size=-1>0x80e8
&lt;main+8>: sub fp, ip, #4</font></font></b></p>
</td>
</tr>

<tr>
<td>
<p CLASS="CodeScreen"><a NAME="pgfId-485430"></a><b><font face="Courier New,Courier"><font size=-1>0x80ec
&lt;main+12>: bl 0x81ec &lt;__gccmain></font></font></b></p>
</td>
</tr>

<tr>
<td>
<p CLASS="CodeScreen"><a NAME="pgfId-485432"></a><b><font face="Courier New,Courier"><font size=-1>0x80f0
&lt;main+16>: mov r0, #7</font></font></b></p>
</td>
</tr>

<tr>
<td>
<p CLASS="CodeScreen"><a NAME="pgfId-485434"></a><b><font face="Courier New,Courier"><font size=-1>0x80f4
&lt;main+20>: bl 0x984c &lt;__thumb_func_from_arm></font></font></b></p>
</td>
</tr>

<tr>
<td>
<p CLASS="CodeScreen"><a NAME="pgfId-485436"></a><b><font face="Courier New,Courier"><font size=-1>0x80f8
&lt;main+24>: add r0, r0, #7</font></font></b></p>
</td>
</tr>

<tr>
<td>
<p CLASS="CodeScreen"><a NAME="pgfId-485438"></a><b><font face="Courier New,Courier"><font size=-1>0x80fc
&lt;main+28>:
ldmdb fp, {fp, sp, lr}</font></font></b></p>
</td>
</tr>

<tr>
<td>
<p CLASS="CodeScreen"><a NAME="pgfId-485440"></a><b><font face="Courier New,Courier"><font size=-1>0x8100
&lt;main+32>: bx lr</font></font></b></p>
</td>
</tr>

<tr>
<td>
<p CLASS="CodeScreen"><a NAME="pgfId-485442"></a><b><font face="Courier New,Courier"><font size=-1>End
of assembler dump.</font></font></b></p>
</td>
</tr>

<tr>
<td>
<p CLASS="CodeScreen"><a NAME="pgfId-485444"></a></p>
</td>
</tr>

<tr>
<td>
<p CLASS="CodeScreen"><a NAME="pgfId-485446"></a><font face="Courier New,Courier"><font size=-1><b>(gdb)
</b>continue</font></font></p>
</td>
</tr>

<tr>
<td>
<p CLASS="CodeScreen"><a NAME="pgfId-485448"></a><b><font face="Courier New,Courier"><font size=-1>Continuing.</font></font></b></p>
</td>
</tr>

<tr>
<td>
<p CLASS="CodeScreen"><a NAME="pgfId-485450"></a></p>
</td>
</tr>

<tr>
<td>
<p CLASS="CodeScreen"><a NAME="pgfId-485452"></a><b><font face="Courier New,Courier"><font size=-1>Breakpoint
2, thumb_func (arg=7) at thumb_stuff.c:1</font></font></b></p>
</td>
</tr>

<tr>
<td>
<p CLASS="CodeScreen"><a NAME="pgfId-485454"></a><b><font face="Courier New,Courier"><font size=-1>1
int thumb_func (int arg) { return arg + 7 ; }</font></font></b></p>
</td>
</tr>

<tr>
<td>
<p CLASS="CodeScreen"><a NAME="pgfId-485456"></a></p>
</td>
</tr>

<tr>
<td>
<p CLASS="CodeScreen"><a NAME="pgfId-485458"></a><font face="Courier New,Courier"><font size=-1><b>(gdb)
</b>disassemble</font></font></p>
</td>
</tr>

<tr>
<td>
<p CLASS="CodeScreen"><a NAME="pgfId-485460"></a><b><font face="Courier New,Courier"><font size=-1>Dump
of assembler code for function thumb_func:</font></font></b></p>
</td>
</tr>

<tr>
<td>
<p CLASS="CodeScreen"><a NAME="pgfId-485462"></a><b><font face="Courier New,Courier"><font size=-1>0x8104
&lt;thumb_func>: 3007 add r0, #7</font></font></b></p>
</td>
</tr>

<tr>
<td>
<p CLASS="CodeScreen"><a NAME="pgfId-485464"></a><b><font face="Courier New,Courier"><font size=-1>0x8106
&lt;thumb_func+2>: 4770 bx lr</font></font></b></p>
</td>
</tr>

<tr>
<td>
<p CLASS="CodeScreen"><a NAME="pgfId-485466"></a><b><font face="Courier New,Courier"><font size=-1>End
of assembler dump.</font></font></b></p>
</td>
</tr>

<tr>
<td>
<p CLASS="CodeScreen"><a NAME="pgfId-485468"></a></p>
</td>
</tr>

<tr>
<td>
<p CLASS="CodeScreen"><a NAME="pgfId-485470"></a><font face="Courier New,Courier"><font size=-1><b>(gdb)
</b>quit</font></font></p>
</td>
</tr>

<tr>
<td>
<p CLASS="CodeScreen"><a NAME="pgfId-485472"></a><font face="Courier New,Courier"><font size=-1><b>The
program is running. Exit anyway? (y or n) </b>y</font></font></p>
</td>
</tr>
</table>


<p CLASS="Body"><a NAME="pgfId-485476"></a>

<p CLASS="Body"><a NAME="pgfId-482614"></a>Note how the ARM '<tt>add</tt>'
instruction at '<b><tt>&lt;main+24></tt></b>' occupies 4 bytes, whereas
the Thumb '<tt>add</tt>' instruction at '<b><tt>&lt;thumb_func></tt></b>'
occupies 2 bytes.

<p CLASS="BodyAfterHead"><a NAME="pgfId-461220"></a>
</body>
</html>
