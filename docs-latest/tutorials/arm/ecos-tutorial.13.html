<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML EXPERIMENTAL 970324//EN">
<HTML>
<HEAD><!--version 1.3.4/Fri Apr 28 12:25:29 BST 2000-->
<META NAME="GENERATOR" CONTENT="Adobe FrameMaker 5.5/HTML Export Filter">
<LINK REL="STYLESHEET" HREF="../cygnus.css">
<TITLE> Building and Running Sample Applications</TITLE></HEAD>
<BODY BGCOLOR="#ffffff">
<DIV>
<TABLE STYLE="ECOS" WIDTH="98%" BORDER="0" ALIGN="LEFT" CELLPADDING="1"><TR><TH COLSPAN="3" ALIGN="center"><P CLASS="Gotos">Building and Running Sample Applications</P></TH></TR><TR><TD  ALIGN="center"><P CLASS="Gotos"><A HREF="ecos-tutorial.2.html">To Contents</A></P></TD><TD  ALIGN="center"><P CLASS="Gotos"><A HREF="ecos-tutorial.12.html">To&nbsp;previous&nbsp;page</A></P></TD><TD ALIGN="center"><P CLASS="Gotos"><A HREF="ecos-tutorial.14.html">To&nbsp;next&nbsp;page</A></P></TD></TR></TABLE><P ALIGN="LEFT">&nbsp;</P><BR><BR><HR ALIGN="center"></DIV>
<H2 CLASS="ChapterTitle">
<A NAME="pgfId=1741760">
 </A>
<A NAME="23350">
 </A>
Building and <A NAME="marker=2490512">
 </A>
Running Sample Applications<DIV>
<IMG SRC="../botclear.gif">
</DIV>
</H2>
<P CLASS="Body">
<A NAME="pgfId=1741761">
 </A>
The example programs in this tutorial are included, along with a <EM CLASS="Emphasis">
Makefile,</EM>
 in the <EM CLASS="Emphasis">
examples</EM>
 directory of the eCos distribution. The first program you will run is a <EM CLASS="Emphasis">
hello world</EM>
-style application, then you will run a more complex application that demonstrates the creation of threads and the use of <EM CLASS="function">
cyg_thread_delay(),</EM>
 and finally you will run one that uses clocks and alarm handlers.</P>
<P CLASS="Body">
<A NAME="pgfId=1741762">
 </A>
The <EM CLASS="Emphasis">
Makefile</EM>
 has two variables you will need to adjust: <EM CLASS="Emphasis">
PKG_INSTALL_DIR</EM>
 and <EM CLASS="Emphasis">
XCC.</EM>
</P>
<P CLASS="Body">
<A NAME="pgfId=1741763">
 </A>
Edit the Makefile, setting <EM CLASS="Emphasis">
PKG_INSTALL_DIR</EM>
 to the install tree previously created by <TT CLASS="Code">
ecosconfig</TT>
 and uncommenting the relevant <EM CLASS="Emphasis">
XCC</EM>
 line for your architecture.</P>
<DIV>
<H3 CLASS="Heading1">
<A NAME="pgfId=1741764">
 </A>
eCos Hello World</H3>
<P CLASS="Body">
<A NAME="pgfId=1741766">
 </A>
The following code is found in the file <TT CLASS="Code">
hello.c</TT>
<A NAME="marker=1741765">
 </A>
 in the <EM CLASS="Emphasis">
examples</EM>
 directory: </P>
<P CLASS="Body">
<A NAME="pgfId=1741767">
 </A>
</P>
<H5 CLASS="Heading4">
<A NAME="pgfId=1741769">
 </A>
eCos <A NAME="marker=1741768">
 </A>
hello world program listing</H5>
<PRE CLASS="CodeExample"><A NAME="pgfId=1741770"> </A>
/* this is a simple hello world program */
#include &lt;stdio.h&gt;
int main(void)
{
 printf(&quot;Hello, eCos world!\n&quot;);
 return 0;
} </PRE>
<P CLASS="Body">
<A NAME="pgfId=2277164">
 </A>
To compile this or any other program that is not part of the eCos distribution, you can follow the procedures described below. Type this explicit compilation instruction (assuming your current working directory is also where you built the eCos kernel):</P>
<PRE CLASS="CodeExample"><A NAME="pgfId=2277165"> </A>
$ gcc -g -IBASE_DIR/ecos-work/install/include hello.c -LBASE_DIR/ecos-work/install/lib -Ttarget.ld -nostdlib</PRE>
<P CLASS="Body">
<A NAME="pgfId=2277166">
 </A>
The compilation instruction above contains some standard GCC options (for example, <TT CLASS="Code">
-g</TT>
 enables debugging), as well as some mention of paths (<TT CLASS="Code">
-IBASE_DIR/ecos-work/install/include</TT>
 allows files like <TT CLASS="Code">
cyg/kernel/kapi.h</TT>
 to be found, and <TT CLASS="Code">
-LBASE_DIR/ecos-work/install/lib</TT>
 allows the linker to find <TT CLASS="Code">
-Ttarget.ld</TT>
). </P>
<P CLASS="Body">
<A NAME="pgfId=1741774">
 </A>
The executable program will be called <TT CLASS="Code">
a.out</TT>
. </P>
<H3 CLASS="Label">
<A NAME="pgfId=2040233">
 </A>
NOTE</H3>
<P CLASS="Note">
<A NAME="pgfId=2040234">
 </A>
Some target systems require special options to be passed to gcc to compile correctly for that system. Please examine the Makefile in the examples directory to see if this applies to your target.</P>
<P CLASS="Body">
<A NAME="pgfId=2336827">
 </A>
You can now run the resulting program in the simulator using GDB the way you ran the test case. The procedure will be the same, but this time run &quot;gdb&quot; specifying &quot;-nw a.out&quot; on the command line:</P>
<PRE CLASS="CodeExample"><A NAME="pgfId=2336828"> </A>
$ gdb -nw a.out</PRE>
<P CLASS="Body">
<A NAME="pgfId=2040251">
 </A>
For targets other than the synthetic linux target, you should now run the usual GDB commands described earlier. Once this is done, typing the command &quot;run&quot; at the (gdb) prompt (&quot;continue&quot; for real hardware) will allow the program to execute and print the string &quot;Hello, eCos world!&quot; on your screen.</P>
<P CLASS="Body">
<A NAME="pgfId=2040256">
 </A>
On the synthetic linux target, you may use the &quot;run&quot; command immediately - you do not need to invoke simulator macros, nor the &quot;load&quot; command.</P>
</DIV>
<DIV>
<H3 CLASS="Heading1">
<A NAME="pgfId=1982019">
 </A>
A Sample Program with Two Threads</H3>
<P CLASS="Body">
<A NAME="pgfId=1741782">
 </A>
Below is a program that uses some of eCos<SPAN CLASS="Bold">
'</SPAN>
 system calls. It creates two threads, each of which goes into an infinite loop in which it sleeps for a while (using <EM CLASS="function">
cyg_thread_delay()</EM>
). This code is found in the file <EM CLASS="Emphasis">
twothreads.c</EM>
<A NAME="marker=1741783">
 </A>
 in the <EM CLASS="Emphasis">
examples</EM>
 directory.</P>
<H4 CLASS="Heading3">
<A NAME="pgfId=1741786">
 </A>
eCos <A NAME="marker=1741785">
 </A>
two-threaded program listing</H4>
<PRE CLASS="CodeExample"><A NAME="pgfId=1741787"> </A>
#include &lt;cyg/kernel/kapi.h&gt;
#include &lt;stdio.h&gt;
#include &lt;math.h&gt;
#include &lt;stdlib.h&gt;

/* now declare (and allocate space for) some kernel objects,
 like the two threads we will use */
cyg_thread thread_s[2];	/* space for two thread objects */

char stack[2][4096];	/* space for two 4K stacks */

/* now the handles for the threads */
cyg_handle_t simple_threadA, simple_threadB;

/* and now variables for the procedure which is the thread */
cyg_thread_entry_t simple_program;

/* and now a mutex to protect calls to the C library */
cyg_mutex_t cliblock;

/* we install our own startup routine which sets up threads */
void cyg_user_start(void)
{
 printf(&quot;Entering twothreads' cyg_user_start() function\n&quot;);

 cyg_mutex_init(&amp;cliblock);

 cyg_thread_create(4, simple_program, (cyg_addrword_t) 0,
	&quot;Thread A&quot;, (void *) stack[0], 4096,
	&amp;simple_threadA, &amp;thread_s[0]);
 cyg_thread_create(4, simple_program, (cyg_addrword_t) 1,
	&quot;Thread B&quot;, (void *) stack[1], 4096,
	&amp;simple_threadB, &amp;thread_s[1]);

 cyg_thread_resume(simple_threadA);
 cyg_thread_resume(simple_threadB);
}

/* this is a simple program which runs in a thread */
void simple_program(cyg_addrword_t data)
{
 int message = (int) data;
 int delay;

 printf(&quot;Beginning execution; thread data is %d\n&quot;, message);

 cyg_thread_delay(200);

 for (;;) {
 delay = 200 + (rand() % 50);

 /* note: printf() must be protected by a
 call to cyg_mutex_lock() */
 cyg_mutex_lock(&amp;cliblock); {
 printf(&quot;Thread %d: and now a delay of %d clock ticks\n&quot;,
	message, delay);
 }
 cyg_mutex_unlock(&amp;cliblock);
 cyg_thread_delay(delay);
 }
} </PRE>
<P CLASS="Body">
<A NAME="pgfId=1741788">
 </A>
When you run the program (by typing <TT CLASS="Code">
run</TT>
 at the (<SPAN CLASS="Bold">
gdb</SPAN>
) prompt) the output should look like this:</P>
<PRE CLASS="CodeExample"><A NAME="pgfId=1741789"> </A>
Starting program: BASE_DIR/examples/twothreads.exe
Entering twothreads' cyg_user_start() function
Beginning execution; thread data is 0
Beginning execution; thread data is 1
Thread 0: and now a delay of 240 clock ticks
Thread 1: and now a delay of 225 clock ticks
Thread 1: and now a delay of 234 clock ticks
Thread 0: and now a delay of 231 clock ticks
Thread 1: and now a delay of 224 clock ticks
Thread 0: and now a delay of 249 clock ticks
Thread 1: and now a delay of 202 clock ticks
Thread 0: and now a delay of 235 clock ticks 
</PRE>
<H3 CLASS="Label">
<A NAME="pgfId=2336833">
 </A>
NOTE</H3>
<P CLASS="Note">
<A NAME="pgfId=2336835">
 </A>
When running in a simulator the <A NAME="marker=2336834">
 </A>
delays might be quite long. On a hardware board (where the clock speed is 100 ticks/second) the delays should average to about 2.25 seconds. In simulation, the delay will depend on the speed of the processor and will almost always be much slower than the actual board. You might want to reduce the delay parameter when running in simulation. </P>
<P CLASS="Body">
<A NAME="pgfId=1741796">
 </A>
<A HREF="ecos-tutorial.13.html#38550" CLASS="XRef">
 Two threads with simple print statements after random delays</A>
 shows how this multitasking program executes. Note that apart from the thread creation system calls, this program also creates and uses a <EM CLASS="Emphasis">
mutex</EM>
<A NAME="marker=1741797">
 </A>
 for synchronization between the <EM CLASS="function">
printf()</EM>
 calls in the two threads. This is because the C library standard I/O (by default) is configured not to be thread-safe, which means that if more than one thread is using standard I/O they might corrupt each other. This is fixed by a mutual exclusion (or <EM CLASS="Emphasis">
mutex</EM>
) lockout mechanism: the threads do not call <EM CLASS="function">
printf()</EM>
 until <EM CLASS="function">
cyg_mutex_lock()</EM>
 has returned, which only happens when the other thread calls <EM CLASS="function">
cyg_mutex_unlock().</EM>
</P>
<P CLASS="Body">
<A NAME="pgfId=1741798">
 </A>
You could avoid using the mutex by configuring the C library to be thread-safe (by selecting the component <TT CLASS="Code">
CYGSEM_LIBC_STDIO_THREAD_SAFE_STREAMS</TT>
). Keep in mind that if the C library is thread-safe, you can no longer use <EM CLASS="function">
printf()</EM>
 in <EM CLASS="function">
cyg_user_start().</EM>
 </P>
<P CLASS="FigureTitle">
<A NAME="pgfId=1741802">
 </A>
<A NAME="38550">
 </A>
Two threads with simple print statements after random delays</P>
<DIV>
<IMG SRC="../pix/twothreads2.gif">
</DIV>
<TABLE>
<TR>
<TD ROWSPAN="1" COLSPAN="1">
</TD>
</TR>
</TABLE>
</DIV>
<HR ALIGN="center"><TABLE STYLE="ECOS" WIDTH="98%" BORDER="0" ALIGN="LEFT" CELLPADDING="1"><TR><TH COLSPAN="3" ALIGN="center"><P CLASS="Gotos">Building and Running Sample Applications</P></TH></TR><TR><TD  ALIGN="center"><P CLASS="Gotos"><A HREF="ecos-tutorial.2.html">To Contents</A></P></TD><TD  ALIGN="center"><P CLASS="Gotos"><A HREF="ecos-tutorial.12.html">To&nbsp;previous&nbsp;page</A></P></TD><TD  ALIGN="center"><P CLASS="Gotos"><A HREF="ecos-tutorial.14.html">To&nbsp;next&nbsp;page</A></P></TD></TR></TABLE></BODY>
</HTML>
