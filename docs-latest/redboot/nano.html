<!-- Copyright (C) 2001 Red Hat, Inc.                                -->
<!-- This material may be distributed only subject to the terms      -->
<!-- and conditions set forth in the Open Publication License, v1.0  -->
<!-- or later (the latest version is presently available at          -->
<!-- http://www.opencontent.org/openpub/)                            -->
<!-- Distribution of substantively modified versions of this         -->
<!-- document is prohibited without the explicit permission of the   -->
<!-- copyright holder.                                               -->
<!-- Distribution of the work or derivative of the work in any       -->
<!-- standard (paper) book form is prohibited unless prior           -->
<!-- permission obtained from the copyright holder                   -->
<HTML
><HEAD
><TITLE
>Bright Star Engineering commEngine and nanoEngine</TITLE
><META
NAME="GENERATOR"
CONTENT="Modular DocBook HTML Stylesheet Version 1.54"><LINK
REL="HOME"
TITLE="RedBoot&#8482; User's Guide"
HREF="redboot.html"><LINK
REL="UP"
TITLE="Installation and Testing"
HREF="installation-and-testing.html"><LINK
REL="PREVIOUS"
TITLE="Cirrus Logic EP72xx (EDB7211, EDB7212) "
HREF="edb7xxx.html"></HEAD
><BODY
CLASS="SECT1"
BGCOLOR="#FFFFFF"
TEXT="#000000"
LINK="#0000FF"
VLINK="#840084"
ALINK="#0000FF"
><DIV
CLASS="NAVHEADER"
><TABLE
WIDTH="100%"
BORDER="0"
CELLPADDING="0"
CELLSPACING="0"
><TR
><TH
COLSPAN="3"
ALIGN="center"
>RedBoot&#8482; User's Guide: Document Version 1.5b, May 2001</TH
></TR
><TR
><TD
WIDTH="10%"
ALIGN="left"
VALIGN="bottom"
><A
HREF="edb7xxx.html"
>Prev</A
></TD
><TD
WIDTH="80%"
ALIGN="center"
VALIGN="bottom"
>Chapter 5. Installation and Testing</TD
><TD
WIDTH="10%"
ALIGN="right"
VALIGN="bottom"
>&nbsp;</TD
></TR
></TABLE
><HR
ALIGN="LEFT"
WIDTH="100%"></DIV
><DIV
CLASS="SECT1"
><H1
CLASS="SECT1"
><A
NAME="NANO"
>Bright Star Engineering commEngine and nanoEngine</A
></H1
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN1788"
>Overview</A
></H2
><P
>RedBoot supports a serial port and the built in ethernet port
for communication and downloads. The default serial port settings are 38400,8,N,1.
RedBoot runs from and supports flash management for the system flash region.
These configurations are supported:<P
></P
><UL
><LI
><P
>RedBoot running from the first free block at 0x40000</P
></LI
><LI
><P
>RedBoot running from RAM</P
></LI
></UL
></P
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN1808"
>Initial Installation</A
></H2
><P
>Unlike other targets, the nanoEngine comes equipped with boot firmware
which you cannot modify.  See chapter 5, "nanoEngine Firmware" of the <I
CLASS="CITETITLE"
>nanoEngine Hardware Reference Manual</I
> (we refer to "July 17, 2000
Rev 0.6") from Bright Star Engineering. </P
><P
>Because of this, eCos, and therefore Redboot, only supports RAM and
POST startup types, rather than the more usual ROM, RAM and optionally, POST. </P
><P
>Briefly, the POST-startup RedBoot image lives in flash following the
BSE firmware. The BSE firmware is configured, using its standard <TT
CLASS="COMPUTEROUTPUT"
>bootcmd</TT
> parameter, to jump into the RedBoot image at startup.</P
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN1815"
>Download Instructions</A
></H2
><P
>You can perform the initial load of the POST-startup RedBoot image into
flash using the BSE firmware's <TT
CLASS="COMPUTEROUTPUT"
>load</TT
> command.
This will load a binary file, using TFTP, and program it into flash in one
operation. Because no memory management is used in the BSE firmware, flash
is mapped from address zero upwards, so the address for the RedBoot POST image
is 0x40000.  You must use the binary version of RedBoot for this, <TT
CLASS="FILENAME"
>redboot-post.bin</TT
>.   </P
><P
>This assumes you have set up the other BSE firmware config parameters
such that it can communicate over your network to your TFTP server.       <TABLE
BORDER="0"
BGCOLOR="#E0E0E0"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
>         
&#62;<TT
CLASS="USERINPUT"
><B
>load /tftpboot/redboot-post.bin 40000</B
></TT
>
loading ... erasing blk at 00040000         
erasing blk at 00050000         
94168 bytes loaded cksum 00008579          
done         
&#62;         
&#62; <TT
CLASS="USERINPUT"
><B
>set bootcmd "go 40000"</B
></TT
>
&#62; <TT
CLASS="USERINPUT"
><B
>get</B
></TT
>
myip = 10.16.19.198         
netmask = 255.255.255.0         
eth = 0         
gateway = 10.16.19.66         
serverip = 10.16.19.66         
bootcmd = go 40000         
&#62;   </PRE
></TD
></TR
></TABLE
> <DIV
CLASS="NOTE"
><BLOCKQUOTE
CLASS="NOTE"
><P
><B
>NOTE: </B
>the BSE firmware runs its serial IO at 9600 Baud; RedBoot runs instead
at 38400 Baud. You must select the right baud rate in your terminal program
to be able to set up the BSE firmware.</P
></BLOCKQUOTE
></DIV
> After a reset, the BSE firmware will print <TABLE
BORDER="0"
BGCOLOR="#E0E0E0"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
>Boot: BSE 2000 Sep 12 2000 14:00:30         
autoboot: "go 40000" [hit ESC to abort]</PRE
></TD
></TR
></TABLE
>and then RedBoot starts, switching
to 38400 Baud.</P
><P
>Once you have installed a bootable RedBoot in the system in this manner,
we advise re-installing using the generic method described in <A
HREF="updating-redboot.html"
>Chapter 4</A
>
in order that the Flash Image System contains an appropriate description of
the flash entries.</P
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN1831"
>Cohabiting with POST in Flash</A
></H2
><P
>The configuration export file named <TT
CLASS="FILENAME"
>redboot_POST.ecm</TT
>
configures redboot to build for execution at address 0x50040000 (or, during
bootup, 0x00040000). This is to allow power-on self-test (POST) code or immutable
firmware to live in the lower addresses of the flash and to run before RedBoot
gets control. The assumption is that RedBoot will be entered at its base address
in physical memory, that is 0x00040000.  </P
><P
>Alternatively, for testing, you can call it in an already running system
by using <TT
CLASS="USERINPUT"
><B
>go 0x50040040</B
></TT
> at another RedBoot prompt, or
a branch to that address. The address is where the reset vector points, and
is reported by RedBoot's <TT
CLASS="USERINPUT"
><B
>tftp load</B
></TT
> command and listed
by the <TT
CLASS="USERINPUT"
><B
>fis list</B
></TT
> command, amongst other places. </P
><P
>Using the POST configuration enables a normal config option which causes
linking and initialization against memory layout files called "...post..."
rather than "...rom..." or "...ram..." in the <TT
CLASS="COMPUTEROUTPUT"
>include/pkgconf</TT
> directory. Specifically:    <TABLE
BORDER="0"
BGCOLOR="#E0E0E0"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="PROGRAMLISTING"
>665 Feb  9 17:57 include/pkgconf/mlt_arm_sa11x0_nano_post.h    
839 Feb  9 17:57 include/pkgconf/mlt_arm_sa11x0_nano_post.ldi    
585 Feb  9 17:57 include/pkgconf/mlt_arm_sa11x0_nano_post.mlt</PRE
></TD
></TR
></TABLE
>It
is these you should edit if you wish to move that execution address from 0x50040000
in the POST configuration.  Startup type naturally remains ROM in this configuration.
  </P
><P
>Because the nanoEngine contains immutable boot firmware at the start
of flash, RedBoot for this target is configured to reserve that area in the
Flash Image System, and to create by default an entry for the POST startup
RedBoot.      <TABLE
BORDER="0"
BGCOLOR="#E0E0E0"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
>RedBoot&#62; fis list   
Name              FLASH addr  Mem addr    Length      Entry point   
(reserved)        0x50000000  0x50000000  0x00040000  0x00000000   
RedBoot[post]     0x50040000  0x00100000  0x00020000  0x50040040   
RedBoot[backup]   0x50060000  0x00020000  0x00020000  0x00020040   
RedBoot config    0x503E0000  0x503E0000  0x00010000  0x00000000   
FIS directory     0x503F0000  0x503F0000  0x00010000  0x00000000   
RedBoot&#62;</PRE
></TD
></TR
></TABLE
>    The entry "(reserved)" ensures that the FIS cannot attempt
to overwrite the BSE firmware, thus ensuring that the board remains bootable
and recoverable even after installing a broken RedBoot image.</P
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN1844"
>Special RedBoot Commands</A
></H2
><P
>The nanoEngine/commEngine has one or two Intel i82559 Ethernet controllers
installed, but these have no associated serial EEPROM in which to record their
Ethernet Station Address (ESA, or MAC address). The BSE firmware records an
ESA for the device it uses, but this information is not available to RedBoot;
we cannot share it.</P
><P
>To keep the ESAs for the two ethernet interfaces, two new items of RedBoot
configuration data are introduced.  You can list them with the RedBoot command <TT
CLASS="COMPUTEROUTPUT"
>fconfig -l</TT
> thus:     <TABLE
BORDER="0"
BGCOLOR="#E0E0E0"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="PROGRAMLISTING"
>RedBoot&#62; fconfig -l   
Run script at boot: false    
Use BOOTP for network configuration: false    
Local IP address: 10.16.19.91    
Default server IP address: 10.16.19.66   
Network hardware address [MAC] for eth0: 0x00:0xB5:0xE0:0xB5:0xE0:0x99   
Network hardware address [MAC] for eth1: 0x00:0xB5:0xE0:0xB5:0xE0:0x9A   
GDB connection port: 9000    
Network debug at boot time: false    
RedBoot&#62;</PRE
></TD
></TR
></TABLE
>You should set them before running RedBoot or eCos
applications with the board connected to a network. The <TT
CLASS="COMPUTEROUTPUT"
>fconfig</TT
> command can be used as for any configuration data item;
the entire ESA is entered in one line.</P
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN1851"
>Memory Maps</A
></H2
><P
>The first level page table is located at physical address 0xc0004000.
 No second level tables are used.   <DIV
CLASS="NOTE"
><BLOCKQUOTE
CLASS="NOTE"
><P
><B
>NOTE: </B
>The virtual memory maps in this section use a C and B column to indicate
whether or not the region is cached (C) or buffered (B).</P
></BLOCKQUOTE
></DIV
><TABLE
BORDER="0"
BGCOLOR="#E0E0E0"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="PROGRAMLISTING"
>Physical Address Range     Description 
-----------------------    ---------------------------------- 
0x00000000 - 0x003fffff    4Mb FLASH (nCS0) 
0x18000000 - 0x18ffffff    Internal PCI bus - 2 x i82559 ethernet 
0x40000000 - 0x4fffffff    External IO or PCI bus 
0x80000000 - 0xbfffffff    SA-1110 Internal Registers 
0xc0000000 - 0xc7ffffff    DRAM Bank 0 - 32Mb SDRAM 
0xc8000000 - 0xcfffffff    DRAM Bank 1 - empty 
0xe0000000 - 0xe7ffffff    Cache Clean   

Virtual Address Range    C B  Description 
-----------------------  - -  ---------------------------------- 
0x00000000 - 0x001fffff  Y Y  DRAM - 8Mb to 32Mb 
0x18000000 - 0x180fffff  N N  Internal PCI bus - 2 x i82559 ethernet 
0x40000000 - 0x4fffffff  N N  External IO or PCI bus 
0x50000000 - 0x51ffffff  Y Y  Up to 32Mb FLASH (nCS0) 
0x80000000 - 0xbfffffff  N N  SA-1110 Internal Registers 
0xc0000000 - 0xc0ffffff  N Y  DRAM Bank 0: 8 or 16Mb 
0xc8000000 - 0xc8ffffff  N Y  DRAM Bank 1: 8 or 16Mb or absent 
0xe0000000 - 0xe7ffffff  Y Y  Cache Clean</PRE
></TD
></TR
></TABLE
>The FLASH based
RedBoot POST-startup image occupies virtual addresses 0x50040000 - 0x5005ffff. </P
><P
>The ethernet devices use a "PCI window" to communicate with the CPU.
This is 1Mb of SDRAM which is shared with the ethernet devices that are on
the PCI bus. It is neither cached nor buffered, to ensure that CPU and PCI
accesses see correct data in the correct order. By default it is configured
to be megabyte number 30, at addresses 0x01e00000-0x01efffff. This can be
modified, and indeed must be, if less than 32Mb of SDRAM is installed, via
the memory layout tool, or by moving the section <TT
CLASS="COMPUTEROUTPUT"
>__pci_window</TT
> referred to by symbols <TT
CLASS="COMPUTEROUTPUT"
>CYGMEM_SECTION_pci_window*</TT
> in the linker script.   </P
><P
>Though the nanoEngine ships with 32Mb of SDRAM all attached to DRAM
bank 0, the code can cope with any of these combinations also; "2 x " in this
context means one device in each DRAM Bank.     <TABLE
BORDER="0"
BGCOLOR="#E0E0E0"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="PROGRAMLISTING"
>1 x 8Mb = 8Mb     2 x 8Mb = 16Mb   
1 x 16Mb = 16Mb   2 x 16Mb = 32Mb</PRE
></TD
></TR
></TABLE
>All are programmed the same
in the memory controller.   </P
><P
>Startup code detects which is fitted and programs the memory map accordingly.
If the device(s) is 8Mb, then there are gaps in the physical memory map, because
a high order address bit is not connected. The gaps are the higher 2Mb out
of every 4Mb. The SA11x0 OS timer is used as a polled timer to provide timeout
support within RedBoot.</P
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN1864"
>Nano Platform Port</A
></H2
><P
>The nano is in the set of SA11X0-based platforms. It uses the arm architectural
HAL, the sa11x0 variant HAL, plus the nano platform hal. These are components
        <TABLE
BORDER="0"
BGCOLOR="#E0E0E0"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="PROGRAMLISTING"
>CYGPKG_HAL_ARM                  hal/arm/arch/         
CYGPKG_HAL_ARM_SA11X0           hal/arm/sa11x0/var         
CYGPKG_HAL_ARM_SA11X0_NANO      hal/arm/sa11x0/nano</PRE
></TD
></TR
></TABLE
> respectively.
  </P
><P
>The target name is "nano" which includes all these, plus the ethernet
driver packages, flash driver, and so on.</P
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN1869"
>Ethernet Driver</A
></H2
><P
>The ethernet driver is in two parts:   </P
><P
>A generic ether driver for Intel i8255x series devices, specifically
the i82559, is <TT
CLASS="COMPUTEROUTPUT"
>devs/eth/intel/i82559</TT
>.  Its
package name is <TT
CLASS="COMPUTEROUTPUT"
>CYGPKG_DEVS_ETH_INTEL_I82559</TT
>.
  </P
><P
>The platform-specific ether driver is <TT
CLASS="COMPUTEROUTPUT"
>devs/eth/arm/nano</TT
>.  Its package is <TT
CLASS="COMPUTEROUTPUT"
>CYGPKG_DEVS_ETH_ARM_NANO</TT
>.  This tells the generic driver the address in IO memory
of the chip, for example, and other configuration details. This driver picks
up the ESA from RedBoot's configuration data - unless configured to use a
static ESA in the usual manner. </P
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN1878"
>Rebuilding RedBoot</A
></H2
><P
>The instructions in <A
HREF="rebuilding-redboot.html"
>Chapter 3</A
> should be followed.
The values for TARGET, ARCH_DIR and PLATFORM_DIR on this platform are
&#8220;nano&#8221;, &#8220;arm&#8221; and &#8220;sa11x0/nano&#8221; respectively.
Note that the configuration export files supplied in the <TT
CLASS="COMPUTEROUTPUT"
>hal/arm/sa11x0/nano/<TT
CLASS="REPLACEABLE"
><I
>VERSION</I
></TT
>/misc</TT
>
directory in the RedBoot source tree should be used.</P
></DIV
></DIV
><DIV
CLASS="NAVFOOTER"
><HR
ALIGN="LEFT"
WIDTH="100%"><TABLE
WIDTH="100%"
BORDER="0"
CELLPADDING="0"
CELLSPACING="0"
><TR
><TD
WIDTH="33%"
ALIGN="left"
VALIGN="top"
><A
HREF="edb7xxx.html"
>Prev</A
></TD
><TD
WIDTH="34%"
ALIGN="center"
VALIGN="top"
><A
HREF="redboot.html"
>Home</A
></TD
><TD
WIDTH="33%"
ALIGN="right"
VALIGN="top"
>&nbsp;</TD
></TR
><TR
><TD
WIDTH="33%"
ALIGN="left"
VALIGN="top"
>Cirrus Logic EP72xx (EDB7211, EDB7212)</TD
><TD
WIDTH="34%"
ALIGN="center"
VALIGN="top"
><A
HREF="installation-and-testing.html"
>Up</A
></TD
><TD
WIDTH="33%"
ALIGN="right"
VALIGN="top"
>&nbsp;</TD
></TR
></TABLE
></DIV
></BODY
></HTML
>